<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 分享會回饋表單生成器 (V2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .star-rating input[type="radio"] { display: none; }
        .star-rating label {
            font-size: 2.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s;
        }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating:hover label,
        .star-rating label:hover ~ label { color: #f59e0b; }
        .star-rating input[type="radio"]:hover ~ label { color: #f59e0b; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        
        <!-- Login View -->
        <div id="login-view">
            <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto text-center">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">歡迎使用</h1>
                <p class="mt-2 text-md text-gray-600">請選擇您的身分</p>
                <div class="mt-8 space-y-4">
                    <button id="attendee-btn" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">我是與會者</button>
                    <button id="manager-btn" class="w-full px-6 py-3 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-800 transition">我是管理者</button>
                </div>
                <div id="password-section" class="hidden mt-6">
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">請輸入管理者密碼</label>
                    <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <button id="login-submit-btn" class="w-full mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">登入</button>
                </div>
            </div>
        </div>

        <!-- Main App View (Initially Hidden) -->
        <div id="app-view" class="hidden">
            <!-- View Toggle -->
            <div id="toggle-view-container" class="flex justify-center mb-6 hidden">
                <button id="toggle-view-btn" class="px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    切換到數據後台
                </button>
            </div>

            <!-- Generator View -->
            <div id="generator-view">
                <header class="text-center mb-8">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">AI 分享會回饋表單生成器</h1>
                    <p class="mt-2 text-md text-gray-600">輸入分享會資訊，或上傳簡報檔，快速生成專業的回饋表單。</p>
                </header>

                <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label for="session-topic" class="block text-sm font-medium text-gray-700 mb-1">分享會主題</label>
                            <input type="text" id="session-topic" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="例如：生成式 AI 在製造業的應用">
                        </div>
                        <div>
                            <label for="session-summary" class="block text-sm font-medium text-gray-700 mb-1">分享會內容摘要</label>
                            <textarea id="session-summary" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="簡要說明分享會涵蓋的重點..."></textarea>
                        </div>
                        <div>
                            <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-1">上傳參考檔案 (選填)</label>
                            <input type="file" id="file-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".docx,.pdf,.pptx">
                            <p class="mt-1 text-xs text-gray-500">支援 .docx 檔案。PDF 和 PPTX 支援開發中。</p>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="generate-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                            <span id="btn-text">生成回饋表單</span>
                            <div id="loader" class="loader hidden ml-3"></div>
                        </button>
                    </div>
                </div>
                <div id="form-output" class="bg-white p-6 rounded-2xl shadow-lg hidden"></div>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="hidden">
                <header class="text-center mb-8">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">回饋數據後台</h1>
                    <p class="mt-2 text-md text-gray-600">查看所有分享會的回饋統計與詳細資料。</p>
                </header>
                <div id="stats-container" class="space-y-8">
                    <p class="text-center text-gray-500">正在載入數據...</p>
                </div>
            </div>
        </div>

        <!-- Message Modal -->
        <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden items-center justify-center z-50">
            <div class="relative mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-2xl bg-white">
                <div class="mt-3 text-center">
                    <div id="modal-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100"></div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="modal-title"></h3>
                    
                    <div id="modal-qr-content" class="my-4 hidden">
                         <div id="qrcode" class="flex justify-center"></div>
                         <p class="text-xs text-gray-500 mt-2">用手機掃描上方 QR Code</p>
                         <input type="text" id="form-link" readonly class="w-full mt-2 p-2 text-sm border rounded bg-gray-50 text-center">
                    </div>

                    <p class="text-sm text-gray-500 mt-2 px-7 py-3" id="modal-message"></p>
                    <div class="items-center px-4 py-3">
                        <button id="close-modal-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700">關閉</button>
                    </div>
                </div>
            </div>
        </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT: Firebase Config ---
        // 請將此處的範例設定替換成您自己 Firebase 專案的實際設定。
        const firebaseConfig = {
  apiKey: "AIzaSyCbRwvK7guh61K9kp2QqTrEOE7nuEXIzPg",
  authDomain: "ai-feedback-app-simhope-ai.firebaseapp.com",
  projectId: "ai-feedback-app-simhope-ai",
  storageBucket: "ai-feedback-app-simhope-ai.firebasestorage.app",
  messagingSenderId: "415250131591",
  appId: "1:415250131591:web:4ca7f131bc0340f1fbe622",
  measurementId: "G-TQYH2D77YG"
};
        
        // --- IMPORTANT: Firestore Security Rules ---
        // **FIXED**: The path has been corrected. Please update your Firestore rules with this new version.
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // This path now correctly matches the code's path
            match /artifacts/{appId}/public/data/feedbackSubmissions/{submissionId} {
              allow read, create: if true;
            }
          }
        }
        */
        
        const appId = 'default-app-id';
        const CHART_COLORS = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e'].reverse(); // 從 5 星到 1 星
        let db, auth, userId;
        let nextQuestionNumber = 1; // 新增題號計數器

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const attendeeBtn = document.getElementById('attendee-btn');
        const managerBtn = document.getElementById('manager-btn');
        const passwordSection = document.getElementById('password-section');
        const passwordInput = document.getElementById('password-input');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const generatorView = document.getElementById('generator-view');
        const adminView = document.getElementById('admin-view');
        const toggleViewContainer = document.getElementById('toggle-view-container');
        const toggleViewBtn = document.getElementById('toggle-view-btn');
        const generateBtn = document.getElementById('generate-btn');
        const btnText = document.getElementById('btn-text');
        const loader = document.getElementById('loader');
        const formOutput = document.getElementById('form-output');
        const sessionTopicInput = document.getElementById('session-topic');
        const sessionSummaryInput = document.getElementById('session-summary');
        const fileUpload = document.getElementById('file-upload');
        const messageModal = document.getElementById('message-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalIconContainer = document.getElementById('modal-icon-container');
        const statsContainer = document.getElementById('stats-container');

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            if (!firebaseConfig || firebaseConfig.apiKey === "AIzaSyxxxxxxxxxxxxxxxxxxxxxxx") {
                showModal('設定錯誤', '您尚未設定有效的 Firebase 設定。請將程式碼中的 `firebaseConfig` 物件替換成您從 Firebase 專案中取得的實際設定。', true);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            if (error.code === 'auth/api-key-not-valid') {
                                showModal('Firebase 連線錯誤', '您提供的 Firebase API 金鑰無效。請確認您已將正確的 `firebaseConfig` 貼入程式碼中。', true);
                            } else {
                                showModal('認證失敗', `無法登入，錯誤：${error.message}`, true);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showModal('Firebase 初始化失敗', '請檢查您的 firebaseConfig 物件格式是否正確。', true);
            }
        }

        // --- Login Logic ---
        function showAppView(isManager = false) {
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            if (isManager) {
                // 如果是管理者，直接顯示後台
                toggleViewContainer.classList.remove('hidden');
                generatorView.classList.add('hidden');
                adminView.classList.remove('hidden');
                toggleViewBtn.textContent = '返回表單生成器';
                loadAnd(); // 載入數據
            }
            // 與會者維持不變，預設顯示生成器畫面
        }

        attendeeBtn.addEventListener('click', () => { showAppView(false); });
        managerBtn.addEventListener('click', () => { passwordSection.classList.remove('hidden'); });
        loginSubmitBtn.addEventListener('click', () => {
            if (passwordInput.value === 'admin123') {
                showAppView(true);
            } else {
                showModal('登入失敗', '密碼錯誤，請重試。', true);
                passwordInput.value = '';
            }
        });

        // --- Event Listeners ---
        toggleViewBtn.addEventListener('click', toggleAdminView);
        generateBtn.addEventListener('click', handleGenerateForm);
        closeModalBtn.addEventListener('click', () => {
             messageModal.classList.add('hidden');
             messageModal.classList.remove('flex');
        });

        // --- View Management ---
        function toggleAdminView() {
            if (generatorView.classList.contains('hidden')) {
                generatorView.classList.remove('hidden');
                adminView.classList.add('hidden');
                toggleViewBtn.textContent = '切換到數據後台';
            } else {
                generatorView.classList.add('hidden');
                adminView.classList.remove('hidden');
                toggleViewBtn.textContent = '返回表單生成器';
                loadAnd();
            }
        }

        // --- File Handling ---
        async function getFileContent() {
            const file = fileUpload.files[0];
            if (!file) return "";
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        if (file.name.endsWith('.docx')) {
                            const result = await mammoth.extractRawText({ arrayBuffer: event.target.result });
                            resolve(result.value);
                        } else {
                            resolve("（此檔案格式暫不支援預覽）");
                        }
                    } catch (err) { reject(err); }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        // --- Form Generation Logic ---
        async function handleGenerateForm() {
            const topic = sessionTopicInput.value.trim();
            const summary = sessionSummaryInput.value.trim();
            if (!topic || !summary) {
                showModal('資料不完整', '請輸入分享會的主題和內容摘要。', true);
                return;
            }
            setLoading(true);
            let fileContent = "";
            try {
                if (fileUpload.files.length > 0) fileContent = await getFileContent();
                const customQuestions = await getCustomQuestions(topic, summary, fileContent);
                const sessionId = crypto.randomUUID();
                renderForm(topic, customQuestions, sessionId);
                formOutput.classList.remove('hidden');
            } catch (error) {
                console.error('Error generating form:', error);
                showModal('生成失敗', 'AI 無法生成問題，將僅使用標準問題。', true);
                renderForm(topic, [], crypto.randomUUID());
                formOutput.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }
        
        // --- Form Rendering ---
        function renderForm(topic, customQuestions, sessionId) {
            // ... (前半段的 standardQuestions 和 customQuestionsHtml 保持不變) ...
            const standardQuestions = [
                { id: 'overall-satisfaction', text: '1. 整體而言，您對這次的分享會滿意度如何？' },
                { id: 'content-relevance', text: '2. 分享會的內容對您的工作或學習是否有幫助？' },
                { id: 'speaker-clarity', text: '3. 講者的表達是否清晰易懂？' },
                { id: 'practicality', text: '4. 您認為分享會的內容在實務上應用的可能性高嗎？' }
            ];
            let customQuestionsHtml = '';
            if (customQuestions && customQuestions.length > 0) {
                 customQuestionsHtml = `<div id="ai-questions-container" class="mt-8 border-t pt-6"><h3 class="text-lg font-semibold text-gray-800 mb-4">針對本次主題</h3>${customQuestions.map((q, index) => `<div class="mb-6"><label class="block text-md font-medium text-gray-700 mb-3" data-question-text="${q.question}">${index + 5}. ${q.question}</label><div class="flex items-center space-x-4"><input type="radio" id="custom-${index}-yes" name="custom-${index}" value="是" class="h-4 w-4 text-blue-600" required><label for="custom-${index}-yes">是</label><input type="radio" id="custom-${index}-no" name="custom-${index}" value="否" class="h-4 w-4 text-blue-600"><label for="custom-${index}-no">否</label><input type="radio" id="custom-${index}-neutral" name="custom-${index}" value="無意見" class="h-4 w-4 text-blue-600"><label for="custom-${index}-neutral">無意見</label></div></div>`).join('')}</div>`;
            }
            nextQuestionNumber = standardQuestions.length + (customQuestions ? customQuestions.length : 0) + 1;
            
            formOutput.innerHTML = `<div class="text-center mb-6"><h2 class="text-2xl font-bold">${topic}</h2><p class="text-md text-gray-600 mt-1">分享會回饋表單</p></div>
            <form id="feedback-form" data-session-id="${sessionId}" data-session-topic="${topic}">
                <div class="mb-8">
                    <label for="submitter-name" class="block text-md font-medium text-gray-700 mb-2">您的姓名：</label>
                    <input type="text" id="submitter-name" name="submitter-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="請輸入您的姓名" required>
                </div>
                ${standardQuestions.map(q => `<div class="mb-8"><label class="block text-md font-medium text-gray-700 mb-3">${q.text}</label><div class="star-rating flex flex-row-reverse justify-end"><input type="radio" id="${q.id}-5" name="${q.id}" value="5" required><label for="${q.id}-5">★</label><input type="radio" id="${q.id}-4" name="${q.id}" value="4"><label for="${q.id}-4">★</label><input type="radio" id="${q.id}-3" name="${q.id}" value="3"><label for="${q.id}-3">★</label><input type="radio" id="${q.id}-2" name="${q.id}" value="2"><label for="${q.id}-2">★</label><input type="radio" id="${q.id}-1" name="${q.id}" value="1"><label for="${q.id}-1">★</label></div></div>`).join('')}
                
                <div id="editable-questions-container">${customQuestionsHtml}</div>

                <div class="mt-8 border-t pt-6">
                    <label for="feedback-comments" class="block text-md font-medium text-gray-700 mb-2">其他建議或回饋：</label>
                    <textarea id="feedback-comments" name="feedback-comments" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="任何您想讓我們知道的建議..."></textarea>
                </div>

                <div id="form-editor-controls" class="mt-8 border-t pt-6 text-sm">
    <h3 class="font-semibold mb-2">編輯表單</h3>
    <div class="flex flex-wrap gap-2">
        <button type="button" id="add-star-btn" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">新增星星評分</button>
        <button type="button" id="add-yesno-btn" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">新增是非題</button>
        <button type="button" id="add-text-btn" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">新增簡答題</button>
    </div>
    <div class="mt-4">
        <button type="button" id="publish-btn" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
            發布並產生 QR Code
        </button>
    </div>
</div>
                <div class="mt-8 text-center">
                    <button type="submit" class="w-full sm:w-auto px-10 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">提交回饋</button>
                </div>
            </form>`;

            // 為新按鈕綁定事件
            document.getElementById('feedback-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('add-star-btn').addEventListener('click', () => addQuestion('star'));
            document.getElementById('add-yesno-btn').addEventListener('click', () => addQuestion('yesno'));
            document.getElementById('add-text-btn').addEventListener('click', () => addQuestion('text'));
            document.getElementById('publish-btn').addEventListener('click', handlePublishForm);
        }
        let manualQuestionCounter = 0;
function addQuestion(type) {
            const container = document.getElementById('editable-questions-container');
            const questionId = `manual-${type}-${manualQuestionCounter++}`;
            let questionHtml = '';

            const questionLabel = `<span class="font-semibold text-gray-800 mr-2">${nextQuestionNumber}.</span>`;

            switch (type) {
                case 'star':
                    questionHtml = `
                        <div class="mb-8 manual-question" data-type="star">
                            <div class="flex items-center mb-3">
                                ${questionLabel}
                                <input type="text" placeholder="請在此輸入您的評分問題..." class="w-full px-2 py-1 border border-gray-300 rounded-lg manual-question-input" required>
                            </div>
                            <div class="star-rating flex flex-row-reverse justify-end">
                                <input type="radio" id="${questionId}-5" name="${questionId}" value="5" required><label for="${questionId}-5">★</label>
                                <input type="radio" id="${questionId}-4" name="${questionId}" value="4"><label for="${questionId}-4">★</label>
                                <input type="radio" id="${questionId}-3" name="${questionId}" value="3"><label for="${questionId}-3">★</label>
                                <input type="radio" id="${questionId}-2" name="${questionId}" value="2"><label for="${questionId}-2">★</label>
                                <input type="radio" id="${questionId}-1" name="${questionId}" value="1"><label for="${questionId}-1">★</label>
                            </div>
                        </div>`;
                    break;
                case 'yesno':
                    questionHtml = `
                        <div class="mb-6 manual-question" data-type="yesno">
                            <div class="flex items-center mb-3">
                                ${questionLabel}
                                <input type="text" placeholder="請在此輸入您的是非問題..." class="w-full px-2 py-1 border border-gray-300 rounded-lg manual-question-input" required>
                            </div>
                            <div class="flex items-center space-x-4">
                                <input type="radio" id="${questionId}-yes" name="${questionId}" value="是" class="h-4 w-4 text-blue-600" required><label for="${questionId}-yes">是</label>
                                <input type="radio" id="${questionId}-no" name="${questionId}" value="否" class="h-4 w-4 text-blue-600"><label for="${questionId}-no">否</label>
                                <input type="radio" id="${questionId}-neutral" name="${questionId}" value="無意見" class="h-4 w-4 text-blue-600"><label for="${questionId}-neutral">無意見</label>
                            </div>
                        </div>`;
                    break;
                case 'text':
                    questionHtml = `
                        <div class="mb-8 manual-question" data-type="text">
                            <div class="flex items-center mb-2">
                                ${questionLabel}
                                <input type="text" placeholder="請在此輸入您的簡答問題..." class="w-full px-2 py-1 border border-gray-300 rounded-lg manual-question-input" required>
                            </div>
                            <textarea name="${questionId}" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="回答..."></textarea>
                        </div>`;
                    break;
            }
            container.insertAdjacentHTML('beforeend', questionHtml);
            nextQuestionNumber++; // 題號加 1，為下一個問題做準備
        }
// --- Data Handling (Firebase) ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!db) {
                showModal('錯誤', '資料庫未連接，無法儲存回饋。', true);
                return;
            }
            const form = e.target;
            const formData = new FormData(form);
            const data = {
                sessionId: form.dataset.sessionId,
                sessionTopic: form.dataset.sessionTopic,
                submittedAt: serverTimestamp(),
                submitterName: formData.get('submitter-name'),
                ratings: {},
                customResponses: [],
                manualResponses: [], // 新增一個陣列來儲存手動新增的問題
                comments: formData.get('feedback-comments')
            };

            // 處理標準問題
            ['overall-satisfaction', 'content-relevance', 'speaker-clarity', 'practicality'].forEach(id => {
                data.ratings[id] = parseInt(formData.get(id), 10);
            });

            // 處理 AI 生成的是非題
            form.querySelectorAll('[data-question-text]').forEach((label, index) => {
                const question = label.dataset.questionText;
                const answer = formData.get(`custom-${index}`);
                if (question && answer) data.customResponses.push({ question, answer });
            });
            
            // 處理手動新增的問題
            form.querySelectorAll('.manual-question').forEach(questionDiv => {
                const question = questionDiv.querySelector('.manual-question-input').value;
                const questionType = questionDiv.dataset.type;
                const inputs = questionDiv.querySelectorAll('input[type="radio"], textarea');
                let answer = '';
                if (questionType === 'text') {
                    answer = inputs[0].value;
                } else { // star or yesno
                    const checkedRadio = Array.from(inputs).find(radio => radio.checked);
                    answer = checkedRadio ? checkedRadio.value : '';
                }
                if (question) data.manualResponses.push({ question, answer, type: questionType });
            });


            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/feedbackSubmissions`), data);
                showModal('提交成功！', '感謝您的寶貴回饋。');
                form.reset();
                formOutput.innerHTML = ''; // 清空表單
                formOutput.classList.add('hidden');

            } catch (error) {
                console.error("Error adding document: ", error);
                showModal('提交失敗', '無法將您的回饋儲存至資料庫，請稍後再試。', true);
            }
        }

        // --- 發布表單並產生 QR Code ---
        async function handlePublishForm() {
            if (!db) {
                showModal('錯誤', '資料庫未連接，無法發布。', true);
                return;
            }

            const form = document.getElementById('feedback-form');
            const topic = form.dataset.sessionTopic;

            // 收集所有問題的結構
            const questions = [];
            // 姓名
            questions.push({ type: 'name', text: '您的姓名：', required: true });
            // 標準問題
            form.querySelectorAll('.star-rating').forEach(div => {
                const label = div.previousElementSibling;
                questions.push({ type: 'star', text: label.textContent, id: div.querySelector('input').name });
            });
            // AI 和手動問題
            document.querySelectorAll('#editable-questions-container .mb-6, #editable-questions-container .mb-8').forEach(div => {
                const type = div.dataset.type || 'yesno'; // AI 問題沒有 data-type，預設為 yesno
                const textInput = div.querySelector('.manual-question-input');
                let text = textInput ? textInput.value : div.querySelector('label').textContent;
                
                // 清理題號
                text = text.replace(/^\d+\.\s*/, '');
                
                questions.push({ type: type, text: text });
            });
            // 其他建議
            questions.push({ type: 'textarea', text: '其他建議或回饋：' });

            const formStructure = {
                topic: topic,
                questions: questions,
                createdAt: serverTimestamp()
            };

            try {
                // 將表單結構存到 Firestore
                const docRef = await addDoc(collection(db, "publishedForms"), formStructure);
                const formId = docRef.id;

                // 產生專屬連結
                const url = `${window.location.origin}${window.location.pathname}?formId=${formId}`;
                
                // 顯示 QR Code 和連結
                showQrCodeModal(url);

            } catch (error) {
                console.error("Error publishing form: ", error);
                showModal('發布失敗', '無法將表單儲存至資料庫。', true);
            }
        }

        // --- 顯示 QR Code 彈出視窗 ---
        function showQrCodeModal(url) {
            const qrContainer = document.getElementById('qrcode');
            const linkInput = document.getElementById('form-link');
            const qrContent = document.getElementById('modal-qr-content');
            
            modalTitle.textContent = '發布成功！';
            modalMessage.textContent = '任何人都可以透過此連結或 QR Code 填寫回饋。';
            qrContainer.innerHTML = ''; // 清空舊的 QR Code
            
            // 產生 QR Code
            const qr = qrcode(0, 'L');
            qr.addData(url);
            qr.make();
            qrContainer.innerHTML = qr.createImgTag(5, 2); // size 5, margin 2

            linkInput.value = url;
            qrContent.classList.remove('hidden');
            
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');

            // 隱藏預設的 icon
            modalIconContainer.classList.add('hidden');
        }

        // --- 根據 URL 載入公開表單 ---
        async function loadAndRenderPublicForm(formId) {
            // 隱藏登入和主應用介面
            loginView.classList.add('hidden');
            appView.classList.add('hidden');
            
            try {
                // Firebase 初始化
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                const docRef = doc(db, "publishedForms", formId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // 渲染公開表單
                    // (我們需要在 body 中建立一個新的容器來放公開表單)
                    const publicFormContainer = document.createElement('div');
                    publicFormContainer.className = "container mx-auto p-4 sm:p-6 lg:p-8 max-w-2xl";
                    
                    let questionsHtml = data.questions.map((q, index) => {
                         const name = `q-${index}`;
                         switch (q.type) {
                            case 'name': return `<div class="mb-6"><label class="block text-md font-medium text-gray-700 mb-2">${q.text}</label><input type="text" name="${name}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="請輸入您的姓名" required></div>`;
                            case 'star': return `<div class="mb-8"><label class="block text-md font-medium text-gray-700 mb-3">${q.text}</label><div class="star-rating flex flex-row-reverse justify-end"><input type="radio" id="${name}-5" name="${name}" value="5" required><label for="${name}-5">★</label><input type="radio" id="${name}-4" name="${name}" value="4"><label for="${name}-4">★</label><input type="radio" id="${name}-3" name="${name}" value="3"><label for="${name}-3">★</label><input type="radio" id="${name}-2" name="${name}" value="2"><label for="${name}-2">★</label><input type="radio" id="${name}-1" name="${name}" value="1"><label for="${name}-1">★</label></div></div>`;
                            case 'yesno': return `<div class="mb-6"><label class="block text-md font-medium text-gray-700 mb-3">${q.text}</label><div class="flex items-center space-x-4"><input type="radio" id="${name}-yes" name="${name}" value="是" class="h-4 w-4 text-blue-600" required><label for="${name}-yes">是</label><input type="radio" id="${name}-no" name="${name}" value="否" class="h-4 w-4 text-blue-600"><label for="${name}-no">否</label><input type="radio" id="${name}-neutral" name="${name}" value="無意見" class="h-4 w-4 text-blue-600"><label for="${name}-neutral">無意見</label></div></div>`;
                            case 'text': return `<div class="mb-6"><label class="block text-md font-medium text-gray-700 mb-2">${q.text}</label><textarea name="${name}" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>`;
                            case 'textarea': return `<div class="mt-8 border-t pt-6"><label class="block text-md font-medium text-gray-700 mb-2">${q.text}</label><textarea name="${name}" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>`;
                            default: return '';
                         }
                    }).join('');

                    publicFormContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <div class="text-center mb-6">
                                <h2 class="text-2xl font-bold">${data.topic}</h2>
                                <p class="text-md text-gray-600 mt-1">分享會回饋表單</p>
                            </div>
                            <form id="public-feedback-form">
                                ${questionsHtml}
                                <div class="mt-8 text-center">
                                    <button type="submit" class="w-full sm:w-auto px-10 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">提交回饋</button>
                                </div>
                            </form>
                        </div>`;
                    
                    document.body.appendChild(publicFormContainer);

                    // 為公開表單加上提交邏輯
                    document.getElementById('public-feedback-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const submissionData = {
                            sessionTopic: data.topic,
                            sessionId: formId, // 用發布的表單 ID 作為 sessionId
                            submittedAt: serverTimestamp(),
                            responses: data.questions.map((q, index) => ({
                                question: q.text,
                                answer: formData.get(`q-${index}`) || ''
                            }))
                        };
                        try {
                            await addDoc(collection(db, `artifacts/${appId}/public/data/feedbackSubmissions`), submissionData);
                            publicFormContainer.innerHTML = `<div class="bg-white p-10 rounded-2xl shadow-lg text-center"><h2 class="text-2xl font-bold text-green-600">提交成功！</h2><p class="mt-2 text-gray-600">感謝您的寶貴回饋。</p></div>`;
                        } catch (err) {
                            publicFormContainer.innerHTML = `<div class="bg-white p-10 rounded-2xl shadow-lg text-center"><h2 class="text-2xl font-bold text-red-600">提交失敗</h2><p class="mt-2 text-gray-600">抱歉，發生錯誤，請稍後再試。</p></div>`;
                        }
                    });

                } else {
                    document.body.innerHTML = `<div class="text-center p-10"><h1 class="text-2xl font-bold text-red-600">找不到表單</h1><p class="mt-2 text-gray-600">此回饋表單的連結可能已失效或不存在。</p></div>`;
                }
            } catch (error) {
                console.error("Error loading public form:", error);
                document.body.innerHTML = `<div class="text-center p-10"><h1 class="text-2xl font-bold text-red-600">載入錯誤</h1><p class="mt-2 text-gray-600">無法載入此回饋表單。</p></div>`;
            }
        }
        // --- Admin View Logic ---
        async function loadAnd() {
            if (!db) {
                statsContainer.innerHTML = '<p class="text-center text-red-500">資料庫未連接。</p>';
                return;
            }
            statsContainer.innerHTML = '<p class="text-center text-gray-500">正在載入數據...</p>';
            // **FIXED**: Corrected the collection path to match the submission path.
            const feedbackQuery = query(collection(db, `artifacts/${appId}/public/data/feedbackSubmissions`));
            onSnapshot(feedbackQuery, (querySnapshot) => {
                const submissions = [];
                querySnapshot.forEach((doc) => submissions.push({ id: doc.id, ...doc.data() }));
                if (submissions.length === 0) {
                    statsContainer.innerHTML = '<p class="text-center text-gray-500">目前沒有任何回饋資料。</p>';
                    return;
                }
                const sessions = submissions.reduce((acc, sub) => {
                    const { sessionId, sessionTopic } = sub;
                    if (!acc[sessionId]) acc[sessionId] = { topic: sessionTopic, submissions: [] };
                    acc[sessionId].submissions.push(sub);
                    return acc;
                }, {});
                renderStats(sessions);
            }, (error) => {
                console.error("Error fetching stats:", error);
                statsContainer.innerHTML = '<p class="text-center text-red-500">讀取資料時發生錯誤。</p>';
            });
        }

// --- 全新、美化的 renderStats 函式 ---
        function renderStats(sessions) {
            statsContainer.innerHTML = ''; // 每次都先清空容器

            // 用來追蹤已初始化的 Chart.js 實例
            if (!window.activeCharts) {
                window.activeCharts = new Map();
            }

            // 銷毀舊的圖表實例
            window.activeCharts.forEach((chart) => {
                chart.destroy();
            });
            window.activeCharts.clear();

            Object.entries(sessions).forEach(([sessionId, sessionData]) => {
                const subCount = sessionData.submissions.length;
                if (subCount === 0) return; // 如果沒有回饋，則不顯示卡片

                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-2xl shadow-lg mb-8';

                // --- 資料處理 ---
                const ratingIds = ['overall-satisfaction', 'content-relevance', 'speaker-clarity', 'practicality'];
                const ratingLabels = ['整體滿意度', '內容幫助', '表達清晰', '實務應用'];
                
                let chartsHtml = '';
                let legendsHtml = '';

                ratingIds.forEach((id, index) => {
                    const counts = [0, 0, 0, 0, 0]; // 1星到5星
                    sessionData.submissions.forEach(sub => {
                        const score = sub.ratings[id];
                        if (score >= 1 && score <= 5) counts[score - 1]++;
                    });

                    // 準備圖表和圖例的 HTML
                    chartsHtml += `<div class="relative"><canvas id="chart-${sessionId}-${id}"></canvas><span class="absolute inset-0 flex items-center justify-center text-2xl font-bold text-gray-700">${subCount}<span class="text-xs font-normal ml-1">份</span></span></div>`;
                    
                    const legendItems = counts.map((count, i) => {
                        const percentage = ((count / subCount) * 100).toFixed(0);
                        return `<li class="flex items-center justify-between text-sm"><div class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: ${CHART_COLORS[i]};"></span>${i + 1} 星</div><div class="font-medium text-gray-600">${percentage}%</div></li>`;
                    }).reverse().join(''); // reverse 讓5星在最上面

                    legendsHtml += `<div class="flex flex-col">
                        <h4 class="font-semibold text-gray-800 mb-2 text-center">${ratingLabels[index]}</h4>
                        <ul class="space-y-1">${legendItems}</ul>
                    </div>`;
                });

                // --- 處理其他問題 (這部分邏輯不變) ---
                const questionStats = {};
                 sessionData.submissions.forEach(sub => {
                    (sub.customResponses || []).forEach(res => {
                        if (!questionStats[res.question]) { questionStats[res.question] = { type: 'yesno', answers: {} }; }
                        questionStats[res.question].answers[res.answer] = (questionStats[res.question].answers[res.answer] || 0) + 1;
                    });
                    (sub.manualResponses || []).forEach(res => {
                        if (!questionStats[res.question]) { questionStats[res.question] = { type: res.type, answers: res.type === 'text' ? [] : {} }; }
                        if (res.type === 'text') { questionStats[res.question].answers.push(res.answer); }
                        else if (res.type === 'star') {
                            let current = questionStats[res.question].answers;
                            current.totalScore = (current.totalScore || 0) + parseInt(res.answer, 10);
                            current.count = (current.count || 0) + 1;
                        } else {
                            questionStats[res.question].answers[res.answer] = (questionStats[res.question].answers[res.answer] || 0) + 1;
                        }
                    });
                });
                let questionStatsHtml = Object.entries(questionStats).map(([question, stats]) => {
                    let answersHtml = '';
                    if (stats.type === 'yesno') { answersHtml = Object.entries(stats.answers).map(([answer, count]) => `<span class="mr-4">${answer}: <strong>${count}</strong></span>`).join(''); }
                    else if (stats.type === 'star') { const average = (stats.answers.totalScore / stats.answers.count).toFixed(1); answersHtml = `平均分數: <strong class="text-lg">${average}</strong> / 5`; }
                    else if (stats.type === 'text') {
                        answersHtml = stats.answers.map(answer => `<li class="text-sm text-gray-600 border-b py-1">${answer}</li>`).join('');
                        return `<div class="py-2"><p class="font-semibold text-gray-800">${question}</p><ul class="mt-1 list-disc list-inside">${answersHtml}</ul></div>`;
                    }
                    return `<div class="py-2"><p class="font-semibold text-gray-800">${question}</p><div class="text-sm text-gray-600 mt-1">${answersHtml}</div></div>`;
                }).join('');
                if (questionStatsHtml) { questionStatsHtml = `<div class="mt-6 border-t pt-4"><h3 class="text-md font-semibold mb-2">自訂問題回饋：</h3><div class="space-y-2">${questionStatsHtml}</div></div>`; }
                const commentsHtml = sessionData.submissions.filter(s => s.comments && s.comments.trim() !== '').map(s => `<li class="border-b py-2 text-sm"><strong>${s.submitterName || '匿名'}：</strong> ${s.comments}</li>`).join('');

                // --- 組合卡片 ---
                card.innerHTML = `
                    <h2 class="text-xl font-bold text-gray-900">${sessionData.topic}</h2>
                    <p class="text-sm text-gray-500 mb-6">總共 ${subCount} 份回饋</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-x-8 gap-y-6">
                        ${legendsHtml}
                    </div>
                    ${questionStatsHtml}
                    <div class="mt-6">
                        <h3 class="text-md font-semibold mt-4 mb-2">其他建議：</h3>
                        <ul class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto">${commentsHtml || '<li class="text-gray-400 text-sm">暫無文字回饋</li>'}</ul>
                    </div>
                `;
                statsContainer.appendChild(card);
                
                 // 繪製新的甜甜圈圖
                setTimeout(() => {
                    ratingIds.forEach(id => {
                        const ctx = document.getElementById(`chart-${sessionId}-${id}`);
                        const counts = [0, 0, 0, 0, 0];
                        sessionData.submissions.forEach(sub => {
                            const score = sub.ratings[id];
                            if (score >= 1 && score <= 5) counts[score - 1]++;
                        });

                        if (ctx) {
                            const chart = new Chart(ctx.getContext('2d'), {
                                type: 'doughnut',
                                data: {
                                    datasets: [{
                                        data: counts,
                                        backgroundColor: CHART_COLORS,
                                        borderColor: '#ffffff',
                                        borderWidth: 2,
                                        hoverOffset: 4
                                    }]
                                },
                                options: {
                                    cutout: '80%',
                                    responsive: true,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: { enabled: false }
                                    }
                                }
                            });
                            window.activeCharts.set(ctx.id, chart); // 儲存圖表實例
                        }
                    });
                }, 0);
            });
        }

        // --- UI Control Functions ---
        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            btnText.textContent = isLoading ? '生成中...' : '生成回饋表單';
            loader.classList.toggle('hidden', !isLoading);
        }
        
        function showModal(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            if (isError) {
                modalIconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
                modalIconContainer.innerHTML = `<svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else {
                modalIconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100';
                modalIconContainer.innerHTML = `<svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            }
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
        }

        // --- Gemini API Call ---
        async function getCustomQuestions(topic, summary, fileContent) {
            const prompt = `你是一個活動問卷設計專家。請根據以下 AI 分享會的資訊，設計 2 個最相關、最能評估學習成效的封閉式問題（是/否/無意見）。主題：${topic} 內容摘要：${summary} ${fileContent ? `補充文件內容：\n${fileContent.substring(0, 3000)}` : ''} 請確保問題簡潔明瞭，並以繁體中文回答。`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "OBJECT", properties: { questions: { type: "ARRAY", items: { type: "OBJECT", properties: { question: { type: "STRING" } }, required: ["question"] }}}, required: ["questions"] }
                }
            };
            const apiKey = "AIzaSyBpCzognh-zL7E0rrw9VXQCTsGl6Q9aUP0";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(jsonText).questions || [];
            } catch (error) {
                console.error("Gemini API call failed:", error);
                // Re-throw the error to be caught by the calling function
                throw error;
            }
        }

// --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const formId = urlParams.get('formId');

            if (formId) {
                // 如果網址有 formId，就載入公開表單
                loadAndRenderPublicForm(formId);
            } else {
                // 否則，走正常的管理員/使用者流程
                initializeFirebase();
            }
        });

    </script>
</body>
</ht
